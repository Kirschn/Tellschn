<!Doctype HTML>
<html>

<head>
    <title>Tellschn</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="description" lang="de" content="Der schnelle Weg eine anonyme Meinung zu bekommen">
    <meta name="theme-color" content="#253e59">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta property="og:site_name" content="Tellschn">
    <meta property="og:title" content="Tellschn">
    <meta property="og:description" content="Der schnelle Weg eine anonyme Meinung zu bekommen">
    <meta property="og:url" content="https://tell.kirschn.de/">
    <meta property="og:image" content="https://tell.kirschn.de/assets/images/og.png">
    <meta property="og:type" content="article">
    <link rel="stylesheet" href="assets/stylesheets/stylesheet.css" />
    <link rel="icon" href="assets/images/favicon.ico" />
    <link rel="icon" type="image/png" href="assets/images/favicon.png">
    <script src="assets/js/jquery-3.4.1.min.js"></script>
    <script src="assets/js/tellschn-client.js"></script>
    <script>
        var custom_page_text = "{{custom_page_text}}";
        var token = "{{token}}";
    </script>
</head>

<body>
    <div class="navbar">
        <a href="/">
            <img class="logo" src="assets/images/logo_white.svg" alt="Tellschn" style="height:2em; margin-top: -0.45em;">
        </a>

        <div id="navbar-right">
            <a href="profile.html"><img src="{{profile_image_url}}" style="height:2.2em; margin-top: -0.5em;"></a>
            <div id="user"><a href="/api/logoff"><i class="material-icons">power_settings_new</i></a>
            </div>
        </div>
    </div>
    <div class="loggedin">
        <div id="top">
            <h1>Hallo, @{{display_name}}!</h1>
            <h2>Nachfolgend findest du eine chronologische Übersicht über alle Tells, die du bereits erhalten hast</h2>
            <p id="share_url">Du möchtest mehr Tells? Teile deinen Profillink mit deinen Freunden!</p>
            <input id="url" class="copyurl" type="text" name="profile-url" value="{{{base_url}}}/{{display_name}}" readonly="readonly" /> <button class="copyBtn">Kopieren</button>
        </div>
        <hr/>
        <span id="tells">
        {{>tell_list}}
        </span>

        <div class="pagination">
            <div class="lds-ripple">
                <div></div>
                <div></div>
            </div>
        </div>
        
        <footer>Tellschn ist <a href="https://github.com/Kirschn/Tellschn/tree/V2">freie Software</a></footer>


        <!-- TODO: Popups do not close when clicked out of the window and page always scrolls up to the top -->
        <div id="answer" class="overlay">
            <div class="popup">
                <h2>Antworten</h2>
                <a class="close" href="#">&times;</a>
                <div class="content answer_popup" id="answer_popup_content">
                    <div class="answer_tell">
                        <h3>Tell:</h3>
                        <p id="answer_tellcontent"></p>
                    </div>
                    <div class="answer_container">
                        <textarea data-length="280" id="enter_answer"></textarea>
                        <span class="counter"></span>
                    </div>
                    <div id="button">
                        <button class="send" onclick="answerTell()">Senden</button>
                    </div>
                    <div class="checkboxes">
                        <input type="checkbox" id="tweeting" {{#custom_configuration.std_tweet}}checked{{/custom_configuration.std_tweet}}>
                        <label for="tweeting">Auf Twitter antworten</label>

                        <input type="checkbox" id="profileposting" {{#custom_configuration.std_post_feed}}checked{{/custom_configuration.std_post_feed}}>
                        <label for="profileposting">Auf deinem Tellschn-Profil antworten</label>
                    </div>
                    <div class="checkboxes" id="checkboxes_imagesharing">
                        <input type="checkbox" id="tweet_image" {{#custom_configuration.std_tweet_image}}checked{{/custom_configuration.std_tweet_image}}>
                        <label for="tweet_image">Bild auf Twitter posten</label>
                        
                        <input type="checkbox" id="post_image" {{#custom_configuration.std_post_image}}checked{{/custom_configuration.std_post_image}}>
                        <label for="post_image">Bild auf deinem Tellschn-Profil posten</label>
                    </div>
                </div>
                <div class="content answer_popup" id="answer_popup_response" style="display: none">&nbsp;</div>
            </div>
        </div>
        <div id="edit" class="overlay">
                <div class="popup">
                    <h2>Antwort Bearbeiten</h2>
                    <a class="close" href="#">&times;</a>
                    <div class="content answer_popup" id="edit_popup_content">
                        <div class="answer_tell">
                            <h3>Tell:</h3>
                            <p id="edit_tellcontent"></p>
                        </div>
                        <!-- TODO: Somehow broke class of answer container -->
                        <div class="answer_container">
                            <textarea data-length="280" id="edit_answer"></textarea>
                            <span class="counter"></span>
                        </div>
                        <div id="button">
                            <button class="send" onclick="editTell()">Senden</button>
                        </div>
                        <div class="checkboxes">
                            <input type="checkbox" id="editprofileposting">
                            <label for="editprofileposting">Auf deinem Tellschn-Profil antworten</label>
                        </div>
                        <div class="checkboxes" id="editcheckboxes_imagesharing">
                            
                            <input type="checkbox" id="editpost_image">
                            <label for="editpost_image">Bild auf deinem Tellschn-Profil posten</label>
                        </div>
                    </div>
                </div>
                <div class="content answer_popup" id="edit_popup_response" style="display: none">

                </div>
        </div>
        <div id="confirm_delete" class="overlay">
            <div class="popup">
                <h2>Willst du diesen Tell wirklich löschen?</h2>
                <a class="close" href="#">&times;</a>
                <div class="content">
                    <p>Bist du dir sicher, dass du diesen Tell löschen möchtest? Du kannst ihn danach nicht wiederherstellen!
                    </p>
                    <button class="delete" onclick="deleteTell()">Weg damit!</button> <button class="cancel">Lieber doch nicht...</button>
                </div>
            </div>
        </div>

        <div id="show_img" class="overlay">
            <div class="popup">
                <a class="close" href="#">&times;</a>
                <div class="content">
                    <img src="assets/images/test_image.jpg" id="lightbox_img"/>
                </div>
            </div>
        </div>
        <div id="show_media" class="overlay">
                <div class="popup">
                    <a class="close" href="#">&times;</a>
                    <div class="content">
                        <video src="" id="lightbox_media" controls autoplay>
                            Dein Browser unterstützt leider kein HTML5 Video
                        </video>
                    </div>
                </div>
        </div>

    </div>
    <script async src="assets/js/charcounter.js"></script>
    <script async src="assets/js/copy.js"></script>
    <script>
        var request_in_progress = false;
        var at_end = false;
        var page = 1;
        var delete_buffer = null;
        var answer_id_buffer = null;
        window.onscroll = function (ev) {
            console.log(window.innerHeight, window.scrollY, document.body.offsetHeight)
            if ((window.innerHeight+window.scrollY) > (document.body.offsetHeight - window.innerHeight/4)) {
                // nachladen
                if (!request_in_progress && ! at_end) {
                    request_in_progress = true;
                    $.get("/api/get_own_tells?token=" + token + "&page=" + page, function(next_page) {
                        document.getElementById("tells").innerHTML += next_page;
                        if (next_page == "\r\n<p>Hier sind leider keine Tells :c</p>") {
                            at_end = true;
                        }
                        request_in_progress = false;
                        page++;
                    })
                }
            }
        }
        function filldeletemodal(tell_id) {
            delete_buffer = tell_id;

        }
        function deleteTell() {
            delete_tell(delete_buffer, function(response) {
                if (response.err) throw response.err;
                window.location.hash = "";
                document.getElementById("tell-" + delete_buffer).remove();
                delete_buffer = null;
            })
        }
        function fillanswermodal(tell_id, has_img) {
            if (has_img) {
                document.getElementById("checkboxes_imagesharing").style.display = "inline";
            } else {
                document.getElementById("checkboxes_imagesharing").style.display = "none";

            }
            document.getElementById("answer_tellcontent").innerHTML = document.getElementById("tell_content_" + tell_id).innerHTML;
            answer_id_buffer = tell_id;
        }
        function filleditmodal(tell_id, has_img, was_public, was_img_public) {
            if (has_img) {
                document.getElementById("editcheckboxes_imagesharing").style.display = "inline";
            } else {
                document.getElementById("editcheckboxes_imagesharing").style.display = "none";

            }
            if (was_img_public) {
                $("#editpost_image").attr("checked", "checked");
            }
            if (was_public) {
                $("#editprofileposting").attr("checked", "checked");
            }
            document.getElementById("edit_tellcontent").innerHTML = document.getElementById("tell_content_" + tell_id).innerHTML;
            $("#edit_answer").val(document.getElementById("answer_content_" + tell_id).innerHTML);
            answer_id_buffer = tell_id;
        }
        function answerTell() {
            if (request_in_progress) {
                return;
            }
            request_in_progress = true;
            reply_to_tell(
                answer_id_buffer,
                $("#enter_answer").val(),
                $("#tweeting").is(":checked"),
                $("#profileposting").is(":checked"),
                $("#tweet_image").is(":checked"),
                $("#post_image").is(":checked"),
                function (response) {
                    request_in_progress = false;
                    if (response.err == null) {
                        // answer successful
                        // display success message
                        document.getElementById("answer_popup_content").style.display = "none";
                        document.getElementById("answer_popup_response").style.display = "inline";
                        document.getElementById("answer_popup_response").innerHTML = "Deine Antwort wurde gesendet.<br><br>";
                        document.getElementById("answer_popup_response").innerHTML += '<div class="button"><a href="#" class="answer" onclick="reset_answer_modal()">Okay</a></div>';
                    } else {
                        alert(response);
                        return;
                    }
                }
            )
        }
        function reset_answer_modal () {
            document.getElementById("answer_popup_response").style.display = "none";
            document.getElementById("answer_popup_content").style.display = "inline";
            $("#enter_answer").val(" ");
        }
    </script>
</body>

</html>